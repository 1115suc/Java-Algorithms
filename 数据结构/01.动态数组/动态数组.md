# åŠ¨æ€æ•°ç»„è¯¦è§£

## åŸºæœ¬æ¦‚å¿µ

åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ•°ç»„æ˜¯ç”±ä¸€ç»„å…ƒç´ ï¼ˆå€¼æˆ–å˜é‡ï¼‰ç»„æˆçš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªå…ƒç´ æœ‰è‡³å°‘ä¸€ä¸ªç´¢å¼•æˆ–é”®æ¥æ ‡è¯†

> In computer science, an **array** is a data structure consisting of a collection of *elements* (values or variables), each identified by at least one *array index* or *key*

å› ä¸ºæ•°ç»„å†…çš„å…ƒç´ æ˜¯**è¿ç»­å­˜å‚¨**çš„ï¼Œæ‰€ä»¥æ•°ç»„ä¸­å…ƒç´ çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡å…¶ç´¢å¼•è®¡ç®—å‡ºæ¥ï¼Œä¾‹å¦‚ï¼š

```java
int[] array = {1,2,3,4,5}
```


çŸ¥é“äº†æ•°ç»„çš„**æ•°æ®**èµ·å§‹åœ°å€ `BaseAddress`ï¼Œå°±å¯ä»¥ç”±å…¬å¼ `BaseAddress + i * size` è®¡ç®—å‡ºç´¢å¼• `i` å…ƒç´ çš„åœ°å€

* `i` å³ç´¢å¼•ï¼Œåœ¨ Javaã€C ç­‰è¯­è¨€éƒ½æ˜¯ä» 0 å¼€å§‹
* `size` æ˜¯æ¯ä¸ªå…ƒç´ å ç”¨å­—èŠ‚ï¼Œä¾‹å¦‚ `int` å  `4`ï¼Œ`double` å  `8`

### ğŸ’¾ ç©ºé—´å ç”¨

Java ä¸­æ•°ç»„ç»“æ„ä¸ºï¼š

* 8 å­—èŠ‚ markword
* 4 å­—èŠ‚ class æŒ‡é’ˆï¼ˆå‹ç¼© class æŒ‡é’ˆçš„æƒ…å†µï¼‰
* 4 å­—èŠ‚ æ•°ç»„å¤§å°ï¼ˆå†³å®šäº†æ•°ç»„æœ€å¤§å®¹é‡æ˜¯ $2^{32}$ï¼‰
* æ•°ç»„å…ƒç´  + å¯¹é½å­—èŠ‚ï¼ˆJava ä¸­æ‰€æœ‰å¯¹è±¡å¤§å°éƒ½æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼Œä¸è¶³çš„è¦ç”¨å¯¹é½å­—èŠ‚è¡¥è¶³ï¼‰

ä¾‹å¦‚ï¼š

```java
int[] array = {1, 2, 3, 4, 5};
```


çš„å¤§å°ä¸º 40 ä¸ªå­—èŠ‚ï¼Œç»„æˆå¦‚ä¸‹ï¼š

```
8(markword) + 4(class) + 4(size) + 5*4 + 4(alignment:å­—èŠ‚è¡¥å……)
```


---

## ğŸ”„ åŠ¨æ€æ•°ç»„å®ç°

åŠ¨æ€æ•°ç»„ï¼Œä¹Ÿå«**æ•°ç»„åˆ—è¡¨**ï¼Œæ˜¯ä¸€ç§**åŠ¨æ€**çš„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯æ•°ç»„åˆ—è¡¨çš„é•¿åº¦æ˜¯å¯å˜çš„ï¼Œæ•°ç»„åˆ—è¡¨çš„é•¿åº¦å¯ä»¥åŠ¨æ€çš„å¢åŠ å’Œå‡å°‘

```java
public class DynamicArray implements Iterable<Integer> {
    private int size = 0; // é€»è¾‘å¤§å°
    private int capacity = 8; // å®¹é‡
    private int[] array = {};
    
    /**
     * å‘æœ€åä½ç½® [size] æ·»åŠ å…ƒç´ 
     * @param element å¾…æ·»åŠ å…ƒç´ 
     */
    public void addLast(int element) {
        add(size, element);
    }

    /**
     * å‘ [0 .. size] ä½ç½®æ·»åŠ å…ƒç´ 
     * @param index   ç´¢å¼•ä½ç½®
     * @param element å¾…æ·»åŠ å…ƒç´ 
     */
    public void add(int index, int element) {
        checkAndGrow();

        // æ·»åŠ é€»è¾‘
        if (index >= 0 && index < size) {
            // å‘åæŒªåŠ¨, ç©ºå‡ºå¾…æ’å…¥ä½ç½®
            System.arraycopy(array, index,
                    array, index + 1, size - index);
        }
        array[index] = element;
        size++;
    }

    private void checkAndGrow() {
        // å®¹é‡æ£€æŸ¥
        if (size == 0) {
            array = new int[capacity];
        } else if (size == capacity) {
            // è¿›è¡Œæ‰©å®¹, 1.5 1.618 2
            capacity += capacity >> 1;
            int[] newArray = new int[capacity];
            System.arraycopy(array, 0,
                    newArray, 0, size);
            array = newArray;
        }
    }

    /**
     * ä» [0 .. size) èŒƒå›´åˆ é™¤å…ƒç´ 
     * @param index ç´¢å¼•ä½ç½®
     * @return è¢«åˆ é™¤å…ƒç´ 
     */
    public int remove(int index) { // [0..size)
        int removed = array[index];
        if (index < size - 1) {
            // å‘å‰æŒªåŠ¨
            System.arraycopy(array, index + 1,
                    array, index, size - index - 1);
        }
        size--;
        return removed;
    }


    /**
     * æŸ¥è¯¢å…ƒç´ 
     * @param index ç´¢å¼•ä½ç½®, åœ¨ [0..size) åŒºé—´å†…
     * @return è¯¥ç´¢å¼•ä½ç½®çš„å…ƒç´ 
     */
    public int get(int index) {
        return array[index];
    }

    /**
     * éå†æ–¹æ³•1
     * @param consumer éå†è¦æ‰§è¡Œçš„æ“ä½œ, å…¥å‚: æ¯ä¸ªå…ƒç´ 
     */
    public void foreach(Consumer<Integer> consumer) {
        for (int i = 0; i < size; i++) {
            consumer.accept(array[i]);
        }
    }

    /**
     * éå†æ–¹æ³•2 - è¿­ä»£å™¨éå†
     */
    @Override
    public Iterator<Integer> iterator() {
        return new Iterator<Integer>() {
            int i = 0;

            @Override
            public boolean hasNext() { // æœ‰æ²¡æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ 
                return i < size;
            }

            @Override
            public Integer next() { // è¿”å›å½“å‰å…ƒç´ ,å¹¶ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ 
                return array[i++];
            }
        };
    }

    /**
     * éå†æ–¹æ³•3 - stream éå†
     * @return stream æµ
     */
    public IntStream stream() {
        return IntStream.of(Arrays.copyOfRange(array, 0, size));
    }
}
```


---

## ğŸ“Š äºŒç»´æ•°ç»„

```java
int[][] array = {
    {11, 12, 13, 14, 15},
    {21, 22, 23, 24, 25},
    {31, 32, 33, 34, 35},
};
```


å†…å­˜å›¾å¦‚ä¸‹
![image-20221104114132056.png](img/image-20221104114132056.png)

* äºŒç»´æ•°ç»„å  32 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ `array[0]`ï¼Œ`array[1]`ï¼Œ`array[2]` ä¸‰ä¸ªå…ƒç´ åˆ†åˆ«ä¿å­˜äº†æŒ‡å‘ä¸‰ä¸ªä¸€ç»´æ•°ç»„çš„å¼•ç”¨
* ä¸‰ä¸ªä¸€ç»´æ•°ç»„å„å  40 ä¸ªå­—èŠ‚
* å®ƒä»¬åœ¨å†…å±‚å¸ƒå±€ä¸Šæ˜¯**è¿ç»­**çš„

æ›´ä¸€èˆ¬çš„ï¼Œå¯¹ä¸€ä¸ªäºŒç»´æ•°ç»„ `Array[m][n]`ï¼š

* `m` æ˜¯å¤–å±‚æ•°ç»„çš„é•¿åº¦ï¼Œå¯ä»¥çœ‹ä½œ row è¡Œ
* `n` æ˜¯å†…å±‚æ•°ç»„çš„é•¿åº¦ï¼Œå¯ä»¥çœ‹ä½œ column åˆ—
* å½“è®¿é—® `Array[i][j]`ï¼Œ`0â‰¤ i < m, 0â‰¤ j < n`æ—¶ï¼Œå°±ç›¸å½“äºï¼š
    * å…ˆæ‰¾åˆ°ç¬¬ `i` ä¸ªå†…å±‚æ•°ç»„ï¼ˆè¡Œï¼‰
    * å†æ‰¾åˆ°æ­¤å†…å±‚æ•°ç»„ä¸­ç¬¬ `j` ä¸ªå…ƒç´ ï¼ˆåˆ—ï¼‰

### ğŸ§ª å°æµ‹è¯•

Java ç¯å¢ƒä¸‹ï¼ˆä¸è€ƒè™‘ç±»æŒ‡é’ˆå’Œå¼•ç”¨å‹ç¼©ï¼Œæ­¤ä¸ºé»˜è®¤æƒ…å†µï¼‰ï¼Œæœ‰ä¸‹é¢çš„äºŒç»´æ•°ç»„

```java
byte[][] array = {
    {11, 12, 13, 14, 15},
    {21, 22, 23, 24, 25},
    {31, 32, 33, 34, 35},
};
```


å·²çŸ¥ `array` **å¯¹è±¡**èµ·å§‹åœ°å€æ˜¯ 0x1000ï¼Œé‚£ä¹ˆ 23 è¿™ä¸ªå…ƒç´ çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ

> ç­”ï¼š
>
> * èµ·å§‹åœ°å€ 0x1000
> * å¤–å±‚æ•°ç»„å¤§å°ï¼š16å­—èŠ‚å¯¹è±¡å¤´ + 3å…ƒç´  * æ¯ä¸ªå¼•ç”¨4å­—èŠ‚ + 4 å¯¹é½å­—èŠ‚ = 32 = 0x20
> * ç¬¬ä¸€ä¸ªå†…å±‚æ•°ç»„å¤§å°ï¼š16å­—èŠ‚å¯¹è±¡å¤´ + 5å…ƒç´  * æ¯ä¸ªbyte1å­—èŠ‚ + 3 å¯¹é½å­—èŠ‚ = 24 = 0x18
> * ç¬¬äºŒä¸ªå†…å±‚æ•°ç»„ï¼Œ16å­—èŠ‚å¯¹è±¡å¤´ = 0x10ï¼Œå¾…æŸ¥æ‰¾å…ƒç´ ç´¢å¼•ä¸º 2
> * æœ€åç»“æœ = 0x1000 + 0x20 + 0x18 + 0x10 + 2*1 = 0x104a

---

## ğŸš€ å±€éƒ¨æ€§åŸç†

* CPU è¯»å–å†…å­˜ï¼ˆé€Ÿåº¦æ…¢ï¼‰æ•°æ®åï¼Œä¼šå°†å…¶æ”¾å…¥é«˜é€Ÿç¼“å­˜ï¼ˆé€Ÿåº¦å¿«ï¼‰å½“ä¸­ï¼Œå¦‚æœåæ¥çš„è®¡ç®—å†ç”¨åˆ°æ­¤æ•°æ®ï¼Œåœ¨ç¼“å­˜ä¸­èƒ½è¯»åˆ°çš„è¯ï¼Œå°±ä¸å¿…è¯»å†…å­˜äº†
* ç¼“å­˜çš„æœ€å°å­˜å‚¨å•ä½æ˜¯ç¼“å­˜è¡Œï¼ˆcache lineï¼‰ï¼Œä¸€èˆ¬æ˜¯ 64 bytesï¼Œä¸€æ¬¡è¯»çš„æ•°æ®å°‘äº†ä¸åˆ’ç®—å•Šï¼Œå› æ­¤æœ€å°‘è¯» 64 bytes å¡«æ»¡ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå› æ­¤è¯»å…¥æŸä¸ªæ•°æ®æ—¶ä¹Ÿä¼šè¯»å–å…¶**ä¸´è¿‘çš„æ•°æ®**ï¼Œè¿™å°±æ˜¯æ‰€è°“**ç©ºé—´å±€éƒ¨æ€§**

### âš¡ å¯¹æ•ˆç‡çš„å½±å“

æ¯”è¾ƒä¸‹é¢ `ij` å’Œ `ji` ä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ•ˆç‡

```java
int rows = 1000000;
int columns = 14;
int[][] a = new int[rows][columns];
```


ij æ–¹æ³•

```java
public static void ij(int[][] a, int rows, int columns) {
    long sum = 0L;
    for (int i = 0; i < rows; i++) {
        for (int j = 0; j < columns; j++) {
            sum += a[i][j];
        }
    }
    System.out.println(sum);
}
```


ji æ–¹æ³•

```java
public static void ji(int[][] a, int rows, int columns) {
    long sum = 0L;
    for (int j = 0; j < columns; j++) {
        for (int i = 0; i < rows; i++) {
            sum += a[i][j];
        }
    }
    System.out.println(sum);
}
```


æ‰§è¡Œç»“æœ

```
0
0
StopWatch '': running time = 96283300 ns
---------------------------------------------
ns         %     Task name
---------------------------------------------
016196200  017%  ij
080087100  083%  ji
```


å¯ä»¥çœ‹åˆ° `ij` çš„æ•ˆç‡æ¯” `ji` å¿«å¾ˆå¤šï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

* ç¼“å­˜æ˜¯æœ‰é™çš„ï¼Œå½“æ–°æ•°æ®æ¥äº†åï¼Œä¸€äº›æ—§çš„ç¼“å­˜è¡Œæ•°æ®å°±ä¼šè¢«è¦†ç›–
* å¦‚æœä¸èƒ½å……åˆ†åˆ©ç”¨ç¼“å­˜çš„æ•°æ®ï¼Œå°±ä¼šé€ æˆæ•ˆç‡ä½ä¸‹

ä»¥ `ji` æ‰§è¡Œä¸ºä¾‹ï¼Œç¬¬ä¸€æ¬¡å†…å¾ªç¯è¦è¯»å…¥ `[0,0]` è¿™æ¡æ•°æ®ï¼Œç”±äºå±€éƒ¨æ€§åŸç†ï¼Œè¯»å…¥ `[0,0]` çš„åŒæ—¶ä¹Ÿè¯»å…¥äº† `[0,1] ... [0,13]`ï¼Œå¦‚å›¾æ‰€ç¤º
![image-20221104164329026.png](img/image-20221104164329026.png)

ä½†å¾ˆé—æ†¾ï¼Œç¬¬äºŒæ¬¡å†…å¾ªç¯è¦çš„æ˜¯ `[1,0]` è¿™æ¡æ•°æ®ï¼Œç¼“å­˜ä¸­æ²¡æœ‰ï¼Œäºæ˜¯å†è¯»å…¥äº†ä¸‹å›¾çš„æ•°æ®
![image-20221104164716282.png](img/image-20221104164716282.png)

è¿™æ˜¾ç„¶æ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸º `[0,1] ... [0,13]` åŒ…æ‹¬ `[1,1] ... [1,13]` è¿™äº›æ•°æ®è™½ç„¶è¯»å…¥äº†ç¼“å­˜ï¼Œå´æ²¡æœ‰åŠæ—¶ç”¨ä¸Šï¼Œè€Œç¼“å­˜çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œç­‰æ‰§è¡Œåˆ°ç¬¬ä¹æ¬¡å†…å¾ªç¯æ—¶
![image-20221104164947154.png](img/image-20221104164947154.png)

ç¼“å­˜çš„ç¬¬ä¸€è¡Œæ•°æ®å·²ç»è¢«æ–°çš„æ•°æ® `[8,0] ... [8,13]` è¦†ç›–æ‰äº†ï¼Œä»¥åå¦‚æœå†æƒ³è¯»ï¼Œæ¯”å¦‚ `[0,1]`ï¼Œåˆå¾—åˆ°å†…å­˜å»è¯»äº†

åŒç†å¯ä»¥åˆ†æ `ij` å‡½æ•°åˆ™èƒ½å……åˆ†åˆ©ç”¨å±€éƒ¨æ€§åŸç†åŠ è½½åˆ°çš„ç¼“å­˜æ•°æ®

---

## âš ï¸ è¶Šç•Œæ£€æŸ¥

è®¿é—®æ•°ç»„è¶Šç•Œï¼Œä¼šæŠ›å‡º `ArrayIndexOutOfBoundsException`

Java ä¸­å¯¹æ•°ç»„å…ƒç´ çš„è¯»å†™éƒ½æœ‰è¶Šç•Œæ£€æŸ¥ï¼Œç±»ä¼¼äºä¸‹é¢çš„ä»£ç 

```c++
bool is_within_bounds(int index) const        
{ 
    return 0 <= index && index < length(); 
}
```


* ä»£ç ä½ç½®ï¼š`openjdk\src\hotspot\share\oops\arrayOop.hpp`

åªä¸è¿‡æ­¤æ£€æŸ¥ä»£ç ï¼Œä¸éœ€è¦ç”±ç¨‹åºå‘˜è‡ªå·±æ¥è°ƒç”¨ï¼ŒJVM ä¼šå¸®æˆ‘ä»¬è°ƒç”¨